# 1. Imagemagick setup
FROM ubuntu:24.04 AS imagemagick-builder

RUN apt-get update && \
    apt-get install -y \
        pkg-config \
        build-essential \
        libltdl-dev \
        libheif-dev \
        libpng-dev \
        libjpeg-dev \
        libwebp-dev \
        git && \
    rm -rf /var/lib/apt/lists/*

RUN cd /usr/local/src && \
    git clone --depth 1 --branch 7.1.0-54 https://github.com/ImageMagick/ImageMagick.git && \
    cd ImageMagick && \
    ./configure \
        --with-modules \
        --with-heic=yes \
        --with-png=yes \
        --with-jpeg=yes \
        --with-webp=yes && \
    make && \
    make install && \
    ldconfig /usr/local/lib

# 2. Commandbox + Imagemagick
FROM ortussolutions/commandbox:jdk21

RUN apt-get update && \
    apt-get install -y \
        libheif1 \
        libpng16-16 \
        libjpeg-turbo8 \
        libwebp7 \
        libltdl7 \
        libgomp1 \
        wget \
        curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Copy ImageMagick from builder stage
COPY --from=imagemagick-builder /usr/local/bin/magick /usr/local/bin/magick
COPY --from=imagemagick-builder /usr/local/lib/libMagick* /usr/local/lib/
COPY --from=imagemagick-builder /usr/local/lib/ImageMagick-7.1.0 /usr/local/lib/ImageMagick-7.1.0
COPY --from=imagemagick-builder /usr/local/etc/ImageMagick-7 /usr/local/etc/ImageMagick-7
COPY --from=imagemagick-builder /usr/local/share/ImageMagick-7 /usr/local/share/ImageMagick-7

RUN ldconfig /usr/local/lib

# Verify imagemagick
RUN magick -version && \
    magick -list format | grep -i heic

# Make sure dependencies are installed
RUN box install

ENV HEALTHCHECK_URI="http://localhost:8082/healthcheck"

WORKDIR ${APP_DIR}